name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
      
      - name: Instalar depend√™ncias
        run: npm ci
      
      - name: Build do projeto
        run: npm run build
      
      - name: Verificar build
        run: |
          if [ ! -d "dist" ]; then
            echo "Erro: Diret√≥rio dist n√£o foi criado"
            exit 1
          fi
          echo "‚úÖ Build conclu√≠do com sucesso!"
      
      - name: Instalar Railway CLI
        run: npm install -g @railway/cli@latest
      
      - name: Deploy para Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üöÄ Iniciando deploy para Railway..."
          echo "üìã Project ID: ${RAILWAY_PROJECT_ID:-n√£o configurado}"
          echo "üìã Service ID: ${RAILWAY_SERVICE_ID:-n√£o configurado}"
          # Verifica se o token est√° configurado
          if [ -z "$RAILWAY_TOKEN" ] || [ "$RAILWAY_TOKEN" == "" ]; then
            echo "‚ö†Ô∏è Aviso: RAILWAY_TOKEN n√£o est√° configurado nos secrets do GitHub"
            echo "üìù Para configurar:"
            echo "   1. Acesse: https://github.com/vinicius08oliveira85/Analisedia/settings/secrets/actions"
            echo "   2. Clique em 'New repository secret'"
            echo "   3. Nome: RAILWAY_TOKEN"
            echo "   4. Valor: Cole o token do Railway (obtenha em https://railway.app/dashboard)"
            echo "‚ùå Deploy cancelado - configure o secret primeiro"
            exit 1
          fi
          echo "‚úÖ Token configurado, continuando deploy..."
          
          # Linka o projeto ao Railway (se necess√°rio)
          if [ -n "$RAILWAY_PROJECT_ID" ] && [ "$RAILWAY_PROJECT_ID" != "" ]; then
            echo "üîó Linking projeto: $RAILWAY_PROJECT_ID"
            railway link $RAILWAY_PROJECT_ID || true
          fi
          
          # Faz o deploy
          echo "üì¶ Fazendo deploy..."
          if [ -n "$RAILWAY_SERVICE_ID" ] && [ "$RAILWAY_SERVICE_ID" != "" ]; then
            echo "üéØ Usando servi√ßo espec√≠fico: $RAILWAY_SERVICE_ID"
            railway up --service $RAILWAY_SERVICE_ID
          else
            echo "‚ö†Ô∏è RAILWAY_SERVICE_ID n√£o configurado. Tentando deploy sem especificar servi√ßo..."
            echo "üìù Se houver m√∫ltiplos servi√ßos, configure RAILWAY_SERVICE_ID nos secrets do GitHub"
            echo ""
            echo "   Para obter o Service ID:"
            echo "   1. Acesse: https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7"
            echo "   2. Clique no servi√ßo desejado (geralmente o servi√ßo principal Node.js)"
            echo "   3. Na URL do navegador, voc√™ ver√°:"
            echo "      https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7/service/[SERVICE_ID]"
            echo "   4. Copie o SERVICE_ID (parte ap√≥s /service/)"
            echo ""
            railway up || {
              echo "‚ùå Erro: M√∫ltiplos servi√ßos encontrados. Configure RAILWAY_SERVICE_ID nos secrets."
              echo ""
              echo "üìù Para configurar:"
              echo "   1. Acesse: https://github.com/vinicius08oliveira85/Analisedia/settings/secrets/actions"
              echo "   2. Clique em 'New repository secret'"
              echo "   3. Nome: RAILWAY_SERVICE_ID"
              echo "   4. Valor: Cole o ID do servi√ßo do Railway"
              echo ""
              echo "   O Service ID est√° na URL quando voc√™ acessa o servi√ßo no Railway Dashboard:"
              echo "   https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7/service/[SERVICE_ID]"
              exit 1
            }
          fi
          echo "‚úÖ Deploy conclu√≠do com sucesso!"

