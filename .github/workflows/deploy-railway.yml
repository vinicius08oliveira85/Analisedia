name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    # S√≥ faz deploy em push para main ou execu√ß√£o manual
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
      
      - name: Instalar depend√™ncias
        run: npm ci
      
      - name: Instalar Railway CLI
        run: |
          # Tenta instalar via npm primeiro (m√©todo mais confi√°vel)
          echo "üì¶ Tentando instalar Railway CLI via npm..."
          npm install -g @railway/cli@latest || {
            echo "‚ö†Ô∏è Instala√ß√£o via npm falhou, tentando m√©todo alternativo..."
            
            # M√©todo alternativo: baixar bin√°rio diretamente do GitHub releases
            echo "üì¶ Instalando Railway CLI via bin√°rio..."
            
            # Cria diret√≥rio para o Railway CLI
            mkdir -p $HOME/.railway/bin
            
            # Detecta arquitetura
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              *) echo "‚ùå Arquitetura n√£o suportada: $ARCH"; exit 1 ;;
            esac
            
            # Detecta sistema operacional
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            
            # Baixa a vers√£o mais recente do Railway CLI
            echo "üîç Buscando vers√£o mais recente do Railway CLI..."
            VERSION=$(curl -s https://api.github.com/repos/railwayapp/cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')
            
            if [ -z "$VERSION" ]; then
              echo "‚ö†Ô∏è N√£o foi poss√≠vel obter a vers√£o via API, usando vers√£o fixa..."
              VERSION="3.15.5"
            fi
            
            echo "üì• Baixando Railway CLI vers√£o $VERSION para $OS/$ARCH..."
            
            # URL do bin√°rio (formato correto do Railway CLI)
            BINARY_URL="https://github.com/railwayapp/cli/releases/download/v${VERSION}/railway_${VERSION}_${OS}_${ARCH}.tar.gz"
            
            # Baixa e extrai
            curl -L -f -o railway.tar.gz "$BINARY_URL" || {
              echo "‚ùå Erro ao baixar Railway CLI do GitHub"
              echo "Tentando URL alternativa..."
              BINARY_URL="https://github.com/railwayapp/cli/releases/latest/download/railway_${OS}_${ARCH}.tar.gz"
              curl -L -f -o railway.tar.gz "$BINARY_URL" || {
                echo "‚ùå Todos os m√©todos de instala√ß√£o falharam"
                exit 1
              }
            }
            
            tar -xzf railway.tar.gz -C $HOME/.railway/bin railway || {
              echo "‚ùå Erro ao extrair Railway CLI"
              exit 1
            }
            
            rm -f railway.tar.gz
            
            # Torna execut√°vel
            chmod +x $HOME/.railway/bin/railway
            
            # Adiciona ao PATH
            echo "$HOME/.railway/bin" >> $GITHUB_PATH
            
            # Verifica instala√ß√£o
            $HOME/.railway/bin/railway --version || {
              echo "‚ùå Railway CLI n√£o est√° funcionando ap√≥s instala√ß√£o"
              exit 1
            }
            
            echo "‚úÖ Railway CLI instalado via bin√°rio: $($HOME/.railway/bin/railway --version)"
            exit 0
          }
          
          # Se chegou aqui, npm funcionou
          echo "‚úÖ Railway CLI instalado via npm: $(railway --version)"
      
      - name: Deploy para Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üöÄ Iniciando deploy para Railway..."
          echo "üìã Project ID: ${RAILWAY_PROJECT_ID:-n√£o configurado}"
          echo "üìã Service ID: ${RAILWAY_SERVICE_ID:-n√£o configurado}"
          
          # Verifica se o token est√° configurado
          if [ -z "$RAILWAY_TOKEN" ] || [ "$RAILWAY_TOKEN" == "" ]; then
            echo "‚ö†Ô∏è Aviso: RAILWAY_TOKEN n√£o est√° configurado nos secrets do GitHub"
            echo "üìù Para configurar:"
            echo "   1. Acesse: https://github.com/vinicius08oliveira85/Analisedia/settings/secrets/actions"
            echo "   2. Clique em 'New repository secret'"
            echo "   3. Nome: RAILWAY_TOKEN"
            echo "   4. Valor: Cole o token do Railway (obtenha em https://railway.app/account/tokens)"
            echo "‚ùå Deploy cancelado - configure o secret primeiro"
            exit 1
          fi
          echo "‚úÖ Token configurado, continuando deploy..."
          
          # O Railway CLI usa automaticamente a vari√°vel RAILWAY_TOKEN
          # N√£o precisa de autentica√ß√£o expl√≠cita se a vari√°vel estiver definida
          echo "üîê Usando token do Railway via vari√°vel de ambiente..."
          
          # Verifica se o Railway CLI est√° funcionando
          railway --version || {
            echo "‚ùå Erro: Railway CLI n√£o est√° instalado corretamente"
            exit 1
          }
          echo "‚úÖ Railway CLI instalado: $(railway --version)"
          
          # Linka o projeto ao Railway (se necess√°rio)
          if [ -n "$RAILWAY_PROJECT_ID" ] && [ "$RAILWAY_PROJECT_ID" != "" ]; then
            echo "üîó Linking projeto: $RAILWAY_PROJECT_ID"
            railway link $RAILWAY_PROJECT_ID --yes || true
          fi
          
          # Faz o deploy usando o Dockerfile
          echo "üì¶ Fazendo deploy via Dockerfile..."
          if [ -n "$RAILWAY_SERVICE_ID" ] && [ "$RAILWAY_SERVICE_ID" != "" ]; then
            echo "üéØ Usando servi√ßo espec√≠fico: $RAILWAY_SERVICE_ID"
            railway up --service $RAILWAY_SERVICE_ID --detach
          else
            echo "‚ö†Ô∏è RAILWAY_SERVICE_ID n√£o configurado. Tentando deploy sem especificar servi√ßo..."
            echo "üìù Se houver m√∫ltiplos servi√ßos, configure RAILWAY_SERVICE_ID nos secrets do GitHub"
            echo ""
            echo "   Para obter o Service ID:"
            echo "   1. Acesse: https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7"
            echo "   2. Clique no servi√ßo desejado (geralmente o servi√ßo principal Node.js)"
            echo "   3. Na URL do navegador, voc√™ ver√°:"
            echo "      https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7/service/[SERVICE_ID]"
            echo "   4. Copie o SERVICE_ID (parte ap√≥s /service/)"
            echo ""
            railway up --detach || {
              echo "‚ùå Erro: M√∫ltiplos servi√ßos encontrados. Configure RAILWAY_SERVICE_ID nos secrets."
              echo ""
              echo "üìù Para configurar:"
              echo "   1. Acesse: https://github.com/vinicius08oliveira85/Analisedia/settings/secrets/actions"
              echo "   2. Clique em 'New repository secret'"
              echo "   3. Nome: RAILWAY_SERVICE_ID"
              echo "   4. Valor: Cole o ID do servi√ßo do Railway"
              echo ""
              echo "   O Service ID est√° na URL quando voc√™ acessa o servi√ßo no Railway Dashboard:"
              echo "   https://railway.app/project/3e8b514d-d2d2-4e3a-a61b-e66bcd1a7ed7/service/[SERVICE_ID]"
              exit 1
            }
          fi
          echo "‚úÖ Deploy conclu√≠do com sucesso!"

